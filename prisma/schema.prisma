/// Este es tu archivo de esquema Prisma
/// Aprende más sobre esto en la documentación: https://pris.ly/d/prisma-schema

datasource db {
  provider = "postgresql"
  schemas  = ["public", "logs"]
}

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

// }

// /// https://github.com/kimjbstar/prisma-class-generator

// generator prismaClassGenerator {
//   provider   = "prisma-class-generator"
//   output     = "../src/generated/class-generator"
//   dryRun     = "false"
//   useSwagger = "true"
// }

// /// https://github.com/unlight/prisma-nestjs-graphql

// generator nestgraphql {
//   provider = "node node_modules/prisma-nestjs-graphql"
//   output   = "../src/generated/graphql-nestjs"
// }

// /// https://github.com/vegardit/prisma-generator-nestjs-dto

// generator nestjsDto {
//   provider                        = "prisma-generator-nestjs-dto"
//   output                          = "../src/generated/nestjs-dto"
//   outputToNestJsResourceStructure = "true"
//   exportRelationModifierClasses   = "true"
//   reExport                        = "false"
//   createDtoPrefix                 = "Create"
//   updateDtoPrefix                 = "Update"
//   dtoSuffix                       = "Dto"
//   entityPrefix                    = ""
//   entitySuffix                    = ""
//   fileNamingStyle                 = "camel"
// }

// /// https://github.com/omar-dulaimi/prisma-class-validator-generator

// generator class_validator {
//   provider = "prisma-class-validator-generator"
//   output   = "../src/generated/validator-generator"
// }

/// Enums

// TipoCliente: 1 = NATURAL, 2 = JURIDICA
// MetodoPago: 1 = EFECTIVO, 2 = QR, 3 = TRANSFERENCIA, 4 = CHEQUE, 5 = DEPOSITO

enum ConstanciaEnum {
  RECIBO
  FACTURA

  @@schema("public")
}

// ============================================
// MÓDULO DE SEGURIDAD Y USUARIOS
// ============================================

model Rol {
  id                 Int          @id @default(autoincrement())
  nombre             String       @unique
  descripcion        String?
  estaActivo         Boolean      @default(true)
  userCreateId       String
  userUpdateId       String?
  fechaCreacion      DateTime     @default(now())
  fechaActualizacion DateTime     @updatedAt
  // Relaciones
  usuarioRoles       UsuarioRol[]
  rolPermisos        RolPermiso[]

  @@map("auth_roles")
  @@schema("public")
}

model Permiso {
  id           Int          @id @default(autoincrement())
  nombre       String       @unique
  descripcion  String?
  modulo       String // ej: "productos", "pedidos", "usuarios", "reportes"
  accion       String // ej: "crear", "leer", "actualizar", "eliminar"
  estaActivo   Boolean      @default(true)
  userUpdateId String?
  // Relaciones
  rolPermisos  RolPermiso[]

  @@map("auth_permisos")
  @@schema("public")
}

model RolPermiso {
  id Int @id @default(autoincrement())

  rolId     Int
  permisoId Int
  // Relaciones
  rol       Rol     @relation(fields: [rolId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  permiso   Permiso @relation(fields: [permisoId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@unique([rolId, permisoId])
  @@map("auth_rol_permisos")
  @@schema("public")
}

model Usuario {
  id                        String                     @id @default(cuid()) @db.VarChar(26)
  email                     String                     @unique @db.VarChar(150)
  password                  String                     @db.VarChar(150)
  nombre                    String                     @db.VarChar(30)
  apellidos                 String                     @db.VarChar(30)
  telefono                  String?                    @db.VarChar(10)
  direccion                 String?
  avatar                    String?
  sucursalId                Int? // Sucursal a la que pertenece el usuario
  estaActivo                Boolean                    @default(true)
  emailVerificado           Boolean                    @default(false)
  twoFactorSecret           String?                    @db.VarChar(255)
  twoFactorEnabled          Boolean                    @default(false)
  fechaCreacion             DateTime                   @default(now())
  fechaActualizacion        DateTime                   @updatedAt
  userCreateId              String?
  userUpdateId              String?
  // Relaciones de seguridad
  roles                     UsuarioRol[]
  sesiones                  Sesion[]
  historialLogins           HistorialLogin[]
  dispositivosConfianza     DispositivoConfianza[]
  tokensTemporales          TokenTemporal[]
  // Relaciones de negocio
  mensajesContacto          MensajeContacto[]
  notificaciones            Notificacion[]
  historialEstadosServicios HistorialEstadosServicio[]
  responsableServicios      ResponsableServicio[]
  derivacionesOrigen        DerivacionServicio[]       @relation("DerivacionesOrigen")
  derivacionesDestino       DerivacionServicio[]       @relation("DerivacionesDestino")
  pagosIngresos             PagosIngresos[]
  gastos                    Gastos[]
  arqueosDiarios            ArqueosDiarios[]
  auditLogs                 AuditLog[]
  // Relación con sucursal
  sucursal                  Sucursal?                  @relation("UsuariosSucursal", fields: [sucursalId], references: [id])

  @@map("auth_usuarios")
  @@schema("public")
}

model UsuarioRol {
  id        Int     @id @default(autoincrement())
  usuarioId String  @db.VarChar(26)
  rolId     Int
  // Relaciones
  usuario   Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  rol       Rol     @relation(fields: [rolId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@unique([usuarioId, rolId])
  @@map("auth_usuario_roles")
  @@schema("public")
}

model Sesion {
  id                 String   @id @default(cuid()) @db.VarChar(26)
  usuarioId          String   @db.VarChar(26)
  refreshToken       String   @unique
  userAgent          String?  @db.VarChar(500)
  ipAddress          String?  @db.VarChar(50)
  dispositivo        String?  @db.VarChar(255)
  navegador          String?  @db.VarChar(100)
  ubicacion          String?  @db.VarChar(255)
  estaActiva         Boolean  @default(true)
  fechaCreacion      DateTime @default(now())
  fechaExpiracion    DateTime
  ultimaActividad    DateTime @default(now())
  fechaActualizacion DateTime @updatedAt
  /// Relaciones
  usuario            Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@map("auth_sesiones")
  @@schema("public")
}

model HistorialLogin {
  id           String   @id @default(cuid()) @db.VarChar(26)
  usuarioId    String   @db.VarChar(26)
  exitoso      Boolean
  ipAddress    String?  @db.VarChar(50)
  userAgent    String?  @db.VarChar(500)
  dispositivo  String?  @db.VarChar(255)
  navegador    String?  @db.VarChar(100)
  ubicacion    String?  @db.VarChar(255)
  motivoFallo  String?  @db.VarChar(255)
  fechaIntento DateTime @default(now())
  // Relaciones
  usuario      Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@map("auth_historial_login")
  @@schema("public")
}

model DispositivoConfianza {
  id                String   @id @default(cuid()) @db.VarChar(26)
  usuarioId         String   @db.VarChar(26)
  deviceFingerprint String   @db.VarChar(255)
  deviceName        String?  @db.VarChar(255)
  userAgent         String?  @db.VarChar(500)
  navegador         String?  @db.VarChar(100)
  sistemaOperativo  String?  @db.VarChar(100)
  estaActivo        Boolean  @default(true)
  fechaCreacion     DateTime @default(now())
  fechaExpiracion   DateTime
  ultimoUso         DateTime @default(now())
  // Relaciones
  usuario           Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@unique([usuarioId, deviceFingerprint])
  @@map("auth_dispositivos_confianza")
  @@schema("public")
}

model TokenTemporal {
  id              String   @id @default(cuid()) @db.VarChar(26)
  clave           String // "verify_token", "reset_token", "otp_email", "2fa_secret"
  valor           String   @db.Text
  tipo            String // "verificacion_email", "reset_password", "otp_login", "2fa_setup"
  usuarioId       String   @db.VarChar(26)
  metadatos       Json? // Para datos como { expiresAt, code, attempts }
  fechaExpiracion DateTime
  fechaCreacion   DateTime @default(now())
  // Relaciones
  usuario         Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@unique([usuarioId, tipo])
  @@index([usuarioId])
  @@index([fechaExpiracion])
  @@index([tipo])
  @@map("auth_tokens_temporales")
  @@schema("public")
}

model ConfiguracionAplicacion {
  id                 String   @id @default(cuid()) @db.VarChar(26)
  clave              String   @unique
  valor              String   @db.Text
  tipo               String   @default("texto") // "texto", "numero", "booleano", "json", "html"
  categoria          String   @default("general") // "sistema", "negocio", "politicas", "emails", "apariencia", "seguridad"
  descripcion        String?
  esEditable         Boolean  @default(true)
  userCreateId       String
  userUpdateId       String?
  fechaCreacion      DateTime @default(now())
  fechaActualizacion DateTime @updatedAt

  @@index([categoria])
  @@map("int_configuracion_aplicacion")
  @@schema("public")
}

// ============================================
// MÓDULO DE SUCURSALES (NOTARÍAS)
// ============================================

model Sucursal {
  id                   Int                      @id @default(autoincrement())
  nombre               String                   @unique @db.VarChar(150)
  abreviacion          String                   @unique @db.VarChar(10)
  departamento         String                   @db.VarChar(100)
  direccion            String                   @db.VarChar(255)
  telefono             String?                  @db.VarChar(20)
  email                String?                  @db.VarChar(100)
  usuarioResponsableId String?                  @db.VarChar(26) // Usuario responsable de la sucursal
  estaActiva           Boolean                  @default(true)
  userCreateId         String
  userUpdateId         String?
  fechaCreacion        DateTime                 @default(now())
  fechaActualizacion   DateTime                 @updatedAt
  // Relaciones
  usuarios             Usuario[]                @relation("UsuariosSucursal")
  tiposTramite         TipoTramite[] // tramites por sucursal
  servicios            Servicio[]
  contadoresTicket     ContadorTicketSucursal[]
  comercializadoras    Comercializadora[]

  @@map("cat_sucursales")
  @@schema("public")
}

model ContadorTicketSucursal {
  id                 Int      @id @default(autoincrement())
  sucursalId         Int
  anio               Int // Año completo (ej: 2026)
  mes                Int // Mes (1-12)
  ultimoNumero       Int      @default(0) // Último número generado (se resetea cada mes)
  fechaCreacion      DateTime @default(now())
  fechaActualizacion DateTime @updatedAt

  sucursal Sucursal @relation(fields: [sucursalId], references: [id], onDelete: Cascade)

  @@unique([sucursalId, anio, mes])
  @@map("cat_contadores_ticket_sucursal")
  @@schema("public")
}

// ============================================
// MÓDULO DE TIPOS DE TRÁMITE
// ============================================

model TipoTramite {
  id                 String   @id @default(cuid()) @db.VarChar(26)
  sucursalId         Int
  tipoDocumentoId    String?  @db.VarChar(26)
  nombre             String   @db.VarChar(150)
  colorHex           String   @default("#1abc9c") @db.VarChar(15)
  icon               String   @default("pi pi-code") @db.VarChar(15)
  descripcion        String?  @db.VarChar(500)
  claseTramite       String?  @db.VarChar(50)
  negocio            String?  @db.VarChar(50)
  imagen             String?
  costoBase          Decimal  @default(0.00) @db.Decimal(10, 2)
  estaActiva         Boolean  @default(true)
  userCreateId       String
  userUpdateId       String?
  fechaCreacion      DateTime @default(now())
  fechaActualizacion DateTime @updatedAt

  tipoDocumento TipoDocumento? @relation(fields: [tipoDocumentoId], references: [id])
  sucursal      Sucursal       @relation(fields: [sucursalId], references: [id], onDelete: Cascade)
  servicios     Servicio[]

  @@unique([sucursalId, nombre])
  @@map("cat_tipos_tramite")
  @@schema("public")
}

// ============================================
// MÓDULO DE NOTIFICACIONES
// ============================================

model Notificacion {
  id                 String   @id @default(cuid()) @db.VarChar(26)
  usuarioId          String   @db.VarChar(26)
  titulo             String   @db.VarChar(255)
  mensaje            String   @db.Text
  tipo               String   @default("info") @db.VarChar(20) // "info", "warning", "success", "error"
  leida              Boolean  @default(false)
  icono              String?  @db.VarChar(50)
  ruta               String?  @db.VarChar(255)
  userCreateId       String
  userUpdateId       String?
  fechaCreacion      DateTime @default(now())
  fechaActualizacion DateTime @updatedAt

  // Relaciones
  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([usuarioId])
  @@index([leida])
  @@index([fechaCreacion])
  @@map("int_notificaciones")
  @@schema("public")
}

// ============================================
// MÓDULO DE CONTACTO
// ============================================

model MensajeContacto {
  id                 String   @id @default(cuid()) @db.VarChar(26)
  usuarioId          String?  @db.VarChar(26) // opcional, puede ser un usuario anónimo
  nombre             String
  correo             String
  telefono           String?
  asunto             String
  mensaje            String
  categoria          String   @default("consulta") // "consulta", "queja", "sugerencia", "reclamo", "felicitacion", "otro"
  estado             String   @default("no_leido") // "no_leido", "leido", "en_proceso", "respondido", "cerrado"
  userCreateId       String?
  userUpdateId       String?
  fechaCreacion      DateTime @default(now())
  fechaActualizacion DateTime @updatedAt

  // Relaciones
  usuario Usuario? @relation(fields: [usuarioId], references: [id], onDelete: SetNull)

  @@map("int_mensajes_contacto")
  @@schema("public")
}

// ============================================
// MÓDULO DE CONFIGURACIÓN DEL SISTEMA
// ============================================

// ============================================================================
// BANKING
// ============================================================================

model Banco {
  id                 Int              @id @default(autoincrement())
  nombre             String           @db.VarChar(100)
  userCreateId       String
  userUpdateId       String?
  fechaCreacion      DateTime         @default(now())
  fechaActualizacion DateTime         @updatedAt
  cuentasBancarias   CuentaBancaria[] @relation(name: "BancoCuenta")

  @@map("cat_bancos")
  @@schema("public")
}

model CuentaBancaria {
  id                   Int                    @id @default(autoincrement())
  bancoId              Int
  numeroCuenta         String                 @db.VarChar(50)
  tipoCuenta           String?                @db.VarChar(50)
  saldoActual          Decimal                @default(0.00) @db.Decimal(12, 2)
  userCreateId         String
  userUpdateId         String?
  fechaCreacion        DateTime               @default(now())
  fechaActualizacion   DateTime               @updatedAt
  banco                Banco                  @relation(name: "BancoCuenta", fields: [bancoId], references: [id], onDelete: Cascade)
  pagosIngresos        PagosIngresos[]
  transaccionesEgresos TransaccionesEgresos[]

  @@map("cont_cuentas_bancarias")
  @@schema("public")
}

// ============================================================================
// DOCUMENTS
// ============================================================================

model TipoDocumento {
  id                 String   @id @default(cuid()) @db.VarChar(26)
  nombre             String   @unique @db.VarChar(100)
  descripcion        String   @db.Text
  precioBase         Decimal  @default(0.00) @db.Decimal(10, 2)
  userCreateId       String
  userUpdateId       String?
  fechaCreacion      DateTime @default(now())
  fechaActualizacion DateTime @updatedAt
  estaActivo         Boolean? @default(true)

  plantillasDocumento PlantillaDocumento[]
  servicios           Servicio[]
  tiposTramite        TipoTramite[]

  @@map("cat_tipos_documento")
  @@schema("public")
}

model PlantillaDocumento {
  id                 Int           @id @default(autoincrement())
  tipoDocumentoId    String        @db.VarChar(26)
  nombrePlantilla    String?       @db.VarChar(100)
  descripcion        String?       @db.Text
  contenidoHtml      String?       @db.Text
  estaActiva         Boolean?      @default(true)
  userCreateId       String
  userUpdateId       String?
  fechaCreacion      DateTime      @default(now())
  fechaActualizacion DateTime      @updatedAt
  tipoDocumento      TipoDocumento @relation(fields: [tipoDocumentoId], references: [id])

  @@map("cat_plantillas_documento")
  @@schema("public")
}

model EstadoTramite {
  id                       Int                        @id @default(autoincrement())
  nombre                   String                     @unique @db.VarChar(100)
  descripcion              String?
  colorHex                 String?                    @db.VarChar(7)
  orden                    Int                        @default(0)
  estaActivo               Boolean                    @default(true)
  userCreateId             String
  userUpdateId             String?
  fechaCreacion            DateTime                   @default(now())
  fechaActualizacion       DateTime                   @updatedAt
  historialEstadosServicio HistorialEstadosServicio[]
  serviciosEstadoActual    Servicio[]                 @relation("EstadoActualServicio")

  @@map("cat_estados_tramite")
  @@schema("public")
}

// ============================================================================
// CLIENTS
// ============================================================================

model Cliente {
  id                 String   @id @default(cuid()) @db.VarChar(26)
  tipoCliente        Int // 1 = NATURAL, 2 = JURIDICA @map("tipo")
  direccion          String?  @db.VarChar(255)
  telefono           String?  @db.VarChar(20)
  email              String?  @db.VarChar(100)
  userCreateId       String
  userUpdateId       String?
  fechaCreacion      DateTime @default(now())
  fechaActualizacion DateTime @updatedAt

  personaNatural    PersonaNatural?
  personaJuridica   PersonaJuridica?
  servicios         Servicio[]
  comercializadoras Comercializadora[]
  ventaServicios    VentaServicio[]

  @@map("cat_clientes")
  @@schema("public")
}

model PersonaNatural {
  clienteId          String    @id @db.VarChar(26)
  tipoDocumento      String    @db.VarChar(20) // cedula identidad, pasaporte, c-extrangero
  numeroDocumento    String    @unique @db.VarChar(20)
  nombres            String    @db.VarChar(100)
  apellidos          String    @db.VarChar(100)
  fechaNacimiento    DateTime? @db.Date
  userCreateId       String
  userUpdateId       String?
  fechaCreacion      DateTime  @default(now())
  fechaActualizacion DateTime  @updatedAt

  cliente Cliente @relation(fields: [clienteId], references: [id], onDelete: Cascade)

  @@map("cat_personas_naturales")
  @@schema("public")
}

model PersonaJuridica {
  clienteId          String   @id @db.VarChar(26)
  nit                String?  @unique @db.VarChar(20)
  razonSocial        String   @unique @db.VarChar(150)
  representanteLegal String?  @db.VarChar(150)
  userCreateId       String
  userUpdateId       String?
  fechaCreacion      DateTime @default(now())
  fechaActualizacion DateTime @updatedAt

  cliente Cliente @relation(fields: [clienteId], references: [id], onDelete: Cascade)

  @@map("cat_personas_juridicas")
  @@schema("public")
}

// ============================================================================
// SERVICES & WORKFLOW
// ============================================================================

model Comercializadora {
  id                   Int        @id @default(autoincrement())
  /// tipo 1=techo, 2 = monumental
  tipoComercializadora Int
  // datos como pryecto urb, mza, proy, lote, fecha de recepcion
  metaData             Json
  sucursalId           Int
  clienteId            String     @db.VarChar(26)
  consolidado          Boolean?   @default(false)
  /// posiblemente sea el estado si esta firmado o no
  minuta               String?
  protocolo            String?
  /// fecha de recepcion en fisico del documento
  fechaEnvio           DateTime?
  fechaEnvioTestimonio DateTime?
  userCreateId         String
  userUpdateId         String?
  fechaCreacion        DateTime   @default(now())
  fechaActualizacion   DateTime   @updatedAt
  cliente              Cliente    @relation(fields: [clienteId], references: [id])
  servicios            Servicio[]
  sucursal             Sucursal?  @relation(fields: [sucursalId], references: [id], onDelete: Restrict)

  @@map("core_comercializadoras")
  @@schema("public")
}

model Servicio {
  id                       String                     @id @default(cuid()) @db.VarChar(26)
  codigoTicket             String                     @unique @db.VarChar(20)
  clienteId                String                     @db.VarChar(26)
  comercializadoraId       Int?
  tipoDocumentoId          String                     @db.VarChar(26)
  tipoTramiteId            String                     @db.VarChar(26)
  sucursalId               Int // Sucursal donde se realizó el servicio
  estadoActualId           Int
  fechaInicio              DateTime                   @default(now()) @db.Timestamptz()
  fechaFinalizacion        DateTime?
  fechaEstimadaEntrega     DateTime?
  plazoEntregaDias         Int?
  prioridad                String                     @default("normal") @db.VarChar(20)
  observaciones            String?                    @db.Text
  contenidoFinal           String?                    @db.Text
  montoTotal               Decimal                    @db.Decimal(10, 2)
  saldoPendiente           Decimal                    @db.Decimal(10, 2)
  estaActivo               Boolean                    @default(true)
  userCreateId             String
  userUpdateId             String?
  fechaActualizacion       DateTime                   @updatedAt
  // relaciones 
  cliente                  Cliente                    @relation(fields: [clienteId], references: [id])
  tipoDocumento            TipoDocumento              @relation(fields: [tipoDocumentoId], references: [id])
  tipoTramite              TipoTramite                @relation(fields: [tipoTramiteId], references: [id])
  sucursal                 Sucursal?                  @relation(fields: [sucursalId], references: [id], onDelete: Restrict)
  estadoActual             EstadoTramite?             @relation("EstadoActualServicio", fields: [estadoActualId], references: [id])
  comercializadora         Comercializadora?          @relation(fields: [comercializadoraId], references: [id], onDelete: SetNull)
  historialEstadosServicio HistorialEstadosServicio[]
  responsablesServicio     ResponsableServicio[]
  derivaciones             DerivacionServicio[]
  pagosIngresos            PagosIngresos[]

  @@map("core_servicios")
  @@schema("public")
}

model HistorialEstadosServicio {
  id          Int      @id @default(autoincrement())
  usuarioId   String?  @db.VarChar(26)
  servicioId  String   @db.VarChar(26)
  estadoId    Int
  fechaCambio DateTime @default(now()) @db.Timestamptz()
  comentario  String?  @db.VarChar(255)

  usuario  Usuario?       @relation(fields: [usuarioId], references: [id])
  servicio Servicio?      @relation(fields: [servicioId], references: [id], onDelete: Cascade)
  estado   EstadoTramite? @relation(fields: [estadoId], references: [id])

  @@map("core_historial_estados_servicio")
  @@schema("public")
}

model ResponsableServicio {
  id              Int       @id @default(autoincrement())
  usuarioId       String    @db.VarChar(26)
  servicioId      String    @db.VarChar(26)
  fechaAsignacion DateTime  @default(now()) @db.Timestamptz()
  fechaBaja       DateTime?
  activo          Boolean   @default(true)

  usuario  Usuario  @relation(fields: [usuarioId], references: [id])
  servicio Servicio @relation(fields: [servicioId], references: [id], onDelete: Cascade)

  @@map("core_responsables_servicio")
  @@schema("public")
}

model DerivacionServicio {
  id                   Int       @id @default(autoincrement())
  servicioId           String    @db.VarChar(26)
  usuarioOrigenId      String?   @db.VarChar(26)
  usuarioDestinoId     String    @db.VarChar(26)
  fechaDerivacion      DateTime  @default(now()) @db.Timestamptz()
  motivo               String?   @db.Text
  prioridad            String    @default("normal") @db.VarChar(20) // "baja", "normal", "alta", "urgente"
  comentario           String?   @db.Text
  aceptada             Boolean   @default(false)
  fechaAceptacion      DateTime?
  // Campos para control de derivación
  estaActiva           Boolean   @default(true) // Para soft delete/cancelación
  visualizada          Boolean   @default(false) // Si el usuario destino ya vio la derivación
  fechaVisualizacion   DateTime? // Cuándo fue visualizada
  motivoCancelacion    String?   @db.Text // Razón de cancelación si aplica
  fechaCancelacion     DateTime? // Cuándo fue cancelada
  usuarioCancelacionId String?   @db.VarChar(26) // Quién canceló

  servicio       Servicio @relation(fields: [servicioId], references: [id], onDelete: Cascade)
  usuarioOrigen  Usuario? @relation("DerivacionesOrigen", fields: [usuarioOrigenId], references: [id])
  usuarioDestino Usuario  @relation("DerivacionesDestino", fields: [usuarioDestinoId], references: [id])

  @@index([servicioId])
  @@index([usuarioDestinoId])
  @@index([fechaDerivacion])
  @@index([estaActiva])
  @@index([visualizada])
  @@map("core_derivaciones_servicio")
  @@schema("public")
}

// ============================================================================
// PAYMENTS & INCOME
// ============================================================================

model PagosIngresos {
  id                Int             @id @default(autoincrement())
  servicioId        String?         @db.VarChar(26)
  fecha             DateTime        @default(now()) @db.Timestamptz()
  monto             Decimal         @db.Decimal(10, 2)
  tipoPago          Int // 1 = EFECTIVO, 2 = QR, 3 = TRANSFERENCIA, 4 = CHEQUE, 5 = DEPOSITO
  cuentaBancariaId  Int?
  constanciaTipo    ConstanciaEnum?
  numeroConstancia  String?         @db.VarChar(50)
  concepto          String?         @db.VarChar(255)
  usuarioRegistroId String?         @db.VarChar(26)

  servicio        Servicio?       @relation(fields: [servicioId], references: [id])
  cuentaBancaria  CuentaBancaria? @relation(fields: [cuentaBancariaId], references: [id])
  usuarioRegistro Usuario?        @relation(fields: [usuarioRegistroId], references: [id])

  @@map("cont_pagos_ingresos")
  @@schema("public")
}

// ============================================================================
// EXPENSES & DISBURSEMENTS
// ============================================================================

model Gastos {
  id                 Int      @id @default(autoincrement())
  nombre             String   @db.VarChar(100)
  descripcion        String?  @db.Text
  proveedor          String?  @db.VarChar(100)
  montoTotal         Decimal  @db.Decimal(10, 2)
  montoPagado        Decimal  @default(0) @db.Decimal(10, 2)
  saldo              Decimal? @db.Decimal(10, 2)
  fechaGasto         DateTime @default(now()) @db.Date
  categoria          String?  @db.VarChar(50)
  usuarioId          String?  @db.VarChar(26)
  userCreateId       String
  userUpdateId       String?
  fechaCreacion      DateTime @default(now())
  fechaActualizacion DateTime @updatedAt

  usuario              Usuario?               @relation(fields: [usuarioId], references: [id])
  transaccionesEgresos TransaccionesEgresos[]

  @@map("cont_gastos")
  @@schema("public")
}

model TransaccionesEgresos {
  id               Int      @id @default(autoincrement())
  gastoId          Int
  monto            Decimal  @db.Decimal(10, 2)
  fecha            DateTime @default(now()) @db.Timestamptz()
  cuentaBancariaId Int?
  metodoPago       Int // 1 = EFECTIVO, 2 = QR, 3 = TRANSFERENCIA, 4 = CHEQUE, 5 = DEPOSITO

  gasto          Gastos          @relation(fields: [gastoId], references: [id])
  cuentaBancaria CuentaBancaria? @relation(fields: [cuentaBancariaId], references: [id])

  @@map("cont_transacciones_egresos")
  @@schema("public")
}

// ============================================================================
// DAILY RECONCILIATION
// ============================================================================

model ArqueosDiarios {
  id                    Int      @id @default(autoincrement())
  fecha                 DateTime @unique @default(now()) @db.Date
  usuarioCierreId       String?  @db.VarChar(26)
  totalIngresosEfectivo Decimal  @default(0) @db.Decimal(10, 2)
  totalIngresosBancos   Decimal  @default(0) @db.Decimal(10, 2)
  totalEgresosEfectivo  Decimal  @default(0) @db.Decimal(10, 2)
  totalEgresosBancos    Decimal  @default(0) @db.Decimal(10, 2)
  saldoFinalDia         Decimal  @default(0) @db.Decimal(10, 2)
  observaciones         String?  @db.Text
  fechaCierre           DateTime @default(now()) @db.Timestamptz()

  usuarioCierre Usuario? @relation(fields: [usuarioCierreId], references: [id])

  @@map("cont_arqueos_diarios")
  @@schema("public")
}

// ============================================
// MÓDULO DE AUDITORÍA Y LOGS
// ============================================

// TipoAccion: 1 = CREATE, 2 = UPDATE, 3 = DELETE, 4 = READ, 5 = LOGIN, 6 = LOGOUT, 7 = EXPORT, 8 = IMPORT, 9 = PRINT, 10 = DOWNLOAD, 11 = APPROVE, 12 = REJECT, 13 = ACTIVATE, 14 = DEACTIVATE, 15 = RESTORE, 16 = CUSTOM, 17 = PASSWORD_CHANGE
// NivelLog: 1 = INFO, 2 = WARNING, 3 = ERROR, 4 = CRITICAL, 5 = DEBUG

model AuditLog {
  id                String   @id @default(cuid()) @db.VarChar(26)
  // Información de la acción
  accion            Int // 1 = CREATE, 2 = UPDATE, 3 = DELETE, 4 = READ, etc.
  modulo            String // Ej: "usuarios", "categorias", "faqs", "pedidos"
  tabla             String? // Nombre de la tabla afectada
  registroId        String? // ID del registro afectado
  descripcion       String // Descripción de la acción realizada
  // Usuario que realiza la acción
  usuarioId         String?  @db.VarChar(26)
  usuarioEmail      String?
  usuarioNombre     String?
  usuarioIp         String? // IP del usuario
  userAgent         String? // Navegador/dispositivo usado
  // Datos modificados
  datosAnteriores   Json? // Estado antes de la modificación (para UPDATE/DELETE)
  datosNuevos       Json? // Estado después de la modificación (para CREATE/UPDATE)
  cambiosRealizados Json? // Resumen de campos cambiados
  // Contexto adicional
  metadatos         Json? // Información adicional contextual
  duracionMs        Int? // Duración de la operación en ms
  exitoso           Boolean  @default(true) // Si la operación fue exitosa
  mensajeError      String? // Mensaje de error si falló
  // Timestamps
  fechaCreacion     DateTime @default(now())
  // Relaciones opcionales
  usuario           Usuario? @relation(fields: [usuarioId], references: [id], onDelete: SetNull)

  @@index([usuarioId])
  @@index([modulo])
  @@index([accion])
  @@index([tabla])
  @@index([registroId])
  @@index([fechaCreacion])
  @@map("logs_audit")
  @@schema("logs")
}

model SystemLog {
  id            String   @id @default(cuid()) @db.VarChar(26)
  // Información del log
  nivel         Int      @default(1) // 1 = INFO, 2 = WARNING, 3 = ERROR, 4 = CRITICAL, 5 = DEBUG
  mensaje       String
  contexto      String? // Contexto donde ocurrió (clase, método, etc.)
  modulo        String? // Módulo del sistema
  // Detalles técnicos
  stackTrace    String?  @db.Text // Stack trace completo del error
  metadatos     Json? // Información adicional
  // Usuario relacionado (opcional)
  usuarioId     String?  @db.VarChar(26)
  usuarioEmail  String?
  // Request info
  metodoHttp    String? // GET, POST, PUT, DELETE
  url           String? // URL del endpoint
  requestBody   Json? // Body del request
  responseCode  Int? // Código de respuesta HTTP
  duracionMs    Int? // Duración de la petición
  // Timestamps
  fechaCreacion DateTime @default(now())

  @@index([nivel])
  @@index([modulo])
  @@index([fechaCreacion])
  @@index([usuarioId])
  @@map("logs_system")
  @@schema("logs")
}

model LoginAttempt {
  id                 String   @id @default(cuid()) @db.VarChar(26)
  // Información del intento
  email              String
  exitoso            Boolean
  motivoFallo        String? // Ej: "Credenciales inválidas", "Cuenta bloqueada", "2FA fallido"
  // Información de conexión
  ip                 String
  userAgent          String?
  ubicacion          String? // País, ciudad si está disponible
  dispositivo        String? // Tipo de dispositivo
  navegador          String? // Navegador usado
  // Información de seguridad
  intentosSospechoso Boolean  @default(false) // Marcado como sospechoso
  bloqueado          Boolean  @default(false) // Si se bloqueó la cuenta tras este intento
  // Timestamps
  fechaIntento       DateTime @default(now())

  @@index([email])
  @@index([ip])
  @@index([fechaIntento])
  @@index([exitoso])
  @@map("logs_login_attempts")
  @@schema("logs")
}

model AccessLog {
  id           String   @id @default(cuid()) @db.VarChar(26)
  // Usuario que accede
  usuarioId    String?  @db.VarChar(26)
  usuarioEmail String?
  // Información de acceso
  recurso      String // Recurso al que se accedió
  metodoHttp   String // GET, POST, PUT, DELETE, etc.
  url          String // URL completa
  endpoint     String? // Endpoint específico
  // Request/Response
  requestBody  Json? // Body del request
  queryParams  Json? // Query parameters
  responseCode Int // Código de respuesta HTTP
  responseBody Json? // Body de la respuesta (solo para errores)
  // Performance
  duracionMs   Int // Duración de la petición
  // Información de conexión
  ip           String
  userAgent    String?
  // Timestamps
  fechaAcceso  DateTime @default(now())

  @@index([usuarioId])
  @@index([recurso])
  @@index([metodoHttp])
  @@index([responseCode])
  @@index([fechaAcceso])
  @@map("logs_access")
  @@schema("logs")
}

model DataChangeLog {
  id            String   @id @default(cuid()) @db.VarChar(26)
  // Información del cambio
  tabla         String
  registroId    String
  campo         String // Campo específico que cambió
  valorAnterior String?  @db.Text // Valor anterior (como string)
  valorNuevo    String?  @db.Text // Valor nuevo (como string)
  tipoCambio    String // CREATE, UPDATE, DELETE
  // Usuario responsable
  usuarioId     String?  @db.VarChar(26)
  usuarioEmail  String?
  usuarioNombre String?
  // Contexto
  razonCambio   String? // Razón del cambio si fue proporcionada
  ipOrigen      String?
  // Timestamps
  fechaCambio   DateTime @default(now())

  @@index([tabla])
  @@index([registroId])
  @@index([usuarioId])
  @@index([fechaCambio])
  @@index([campo])
  @@map("logs_data_changes")
  @@schema("logs")
}

model ErrorLog {
  id              String    @id @default(cuid()) @db.VarChar(26)
  // Información del error
  mensaje         String
  tipo            String // Tipo de error (TypeError, ValidationError, etc.)
  codigo          String? // Código de error personalizado
  severidad       String // LOW, MEDIUM, HIGH, CRITICAL
  // Contexto técnico
  stackTrace      String    @db.Text
  contexto        String? // Clase/método donde ocurrió
  modulo          String? // Módulo afectado
  // Request info
  metodoHttp      String?
  url             String?
  requestBody     Json?
  // Usuario afectado
  usuarioId       String?   @db.VarChar(26)
  usuarioEmail    String?
  ip              String?
  // Estado
  resuelto        Boolean   @default(false)
  fechaResolucion DateTime?
  notasResolucion String?   @db.Text
  // Timestamps
  fechaError      DateTime  @default(now())

  @@index([tipo])
  @@index([severidad])
  @@index([resuelto])
  @@index([fechaError])
  @@index([modulo])
  @@map("logs_errors")
  @@schema("logs")
}

model CatalogoServicio {
  id             String   @id @default(cuid())
  codigo         String   @db.VarChar(20) // Código oficial SIN
  nombre         String   @db.VarChar(255)
  descripcion    String?  @db.Text
  precioBase     Decimal? @default(0.00) @db.Decimal(12, 3)
  tarifaVariable Boolean  @default(false)
  activo         Boolean  @default(true)

  userCreateId       String
  userUpdateId       String?
  fechaCreacion      DateTime @default(now())
  fechaActualizacion DateTime @updatedAt

  ventaServicioDetalles VentaServicioDetalle[]

  @@map("fac_catalogos_servicios")
  @@schema("public")
}

model VentaServicio {
  id        String  @id @default(cuid())
  clienteId String
  cliente   Cliente @relation(fields: [clienteId], references: [id])

  tipoTransaccion   String   @db.VarChar(20) // 'RECIBO' o 'FACTURA'
  numeroTransaccion String   @unique @db.VarChar(50)
  fecha             DateTime @default(now())
  total             Decimal  @default(0.00) @db.Decimal(10, 3)

  observaciones String?
  estado        String  @default("PAGADO") @db.VarChar(20) // PENDIENTE, PAGADO, ANULADO

  userCreateId       String
  userUpdateId       String?
  fechaCreacion      DateTime  @default(now())
  fechaActualizacion DateTime?

  detalles VentaServicioDetalle[]

  @@map("fac_ventas_servicios")
  @@schema("public")
}

model VentaServicioDetalle {
  id              String        @id @default(cuid())
  ventaServicioId String
  ventaServicio   VentaServicio @relation(fields: [ventaServicioId], references: [id])

  catalogoServicioId String
  catalogoServicio   CatalogoServicio @relation(fields: [catalogoServicioId], references: [id])

  descripcion    String?
  cantidad       Decimal @default(1)
  precioUnitario Decimal @default(0.00) @db.Decimal(10, 3)
  precioCatalogo Decimal @default(0.00) @db.Decimal(10, 3)
  subtotal       Decimal @default(0.00) @db.Decimal(10, 3)

  descuento Decimal? @default(0.00) @db.Decimal(10, 3)

  codigoActividadSin String? @db.VarChar(20)

  userCreateId       String
  userUpdateId       String?
  fechaCreacion      DateTime  @default(now())
  fechaActualizacion DateTime?

  @@map("fac_ventas_servicios_detalles")
  @@schema("public")
}

model Secuencia {
  id           Int @id @default(autoincrement())
  numeroRecibo Int

  @@map("secuencias")
  @@schema("public")
}
