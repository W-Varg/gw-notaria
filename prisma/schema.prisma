/// Este es tu archivo de esquema Prisma
/// Aprende más sobre esto en la documentación: https://pris.ly/d/prisma-schema

datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

// }

// /// https://github.com/kimjbstar/prisma-class-generator

// generator prismaClassGenerator {
//   provider   = "prisma-class-generator"
//   output     = "../src/generated/class-generator"
//   dryRun     = "false"
//   useSwagger = "true"
// }

// /// https://github.com/unlight/prisma-nestjs-graphql

generator nestgraphql {
  provider = "node node_modules/prisma-nestjs-graphql"
  output   = "../src/generated/graphql-nestjs"
}

// /// https://github.com/vegardit/prisma-generator-nestjs-dto

// generator nestjsDto {
//   provider                        = "prisma-generator-nestjs-dto"
//   output                          = "../src/generated/nestjs-dto"
//   outputToNestJsResourceStructure = "true"
//   exportRelationModifierClasses   = "true"
//   reExport                        = "false"
//   createDtoPrefix                 = "Create"
//   updateDtoPrefix                 = "Update"
//   dtoSuffix                       = "Dto"
//   entityPrefix                    = ""
//   entitySuffix                    = ""
//   fileNamingStyle                 = "camel"
// }

// /// https://github.com/omar-dulaimi/prisma-class-validator-generator

// generator class_validator {
//   provider = "prisma-class-validator-generator"
//   output   = "../src/generated/validator-generator"
// }

/// Enums

enum EstadoPedido {
  PENDIENTE
  CONFIRMADO
  EN_PREPARACION
  LISTO_PARA_ENTREGA
  ENTREGADO
  CANCELADO
  REEMBOLSADO
}

enum EstadoEntrega {
  PENDIENTE
  PROGRAMADA
  EN_CAMINO
  ENTREGADA
  CANCELADA
}

enum UnidadMedida {
  Gramos
  Klg
  Unidad
  Caja
  Paquete
}

enum DiaSemana {
  Lunes
  Martes
  Miercoles
  Jueves
  Viernes
  Sabado
  Domingo
}

enum TipoClienteEnum {
  NATURAL
  JURIDICA
}

enum MetodoPagoEnum {
  EFECTIVO
  QR
  TRANSFERENCIA
  CHEQUE
  DEPOSITO
}

enum ConstanciaEnum {
  RECIBO
  FACTURA
}

// ============================================
// MÓDULO DE SEGURIDAD Y USUARIOS
// ============================================

model Rol {
  id                 Int          @id @default(autoincrement())
  nombre             String       @unique
  descripcion        String?
  estaActivo         Boolean      @default(true)
  fechaCreacion      DateTime     @default(now())
  fechaActualizacion DateTime     @updatedAt
  // Relaciones
  usuarioRoles       UsuarioRol[]
  rolPermisos        RolPermiso[]

  @@map("auth_roles")
}

model Permiso {
  id          Int          @id @default(autoincrement())
  nombre      String       @unique
  descripcion String?
  modulo      String // ej: "productos", "pedidos", "usuarios", "reportes"
  accion      String // ej: "crear", "leer", "actualizar", "eliminar"
  estaActivo  Boolean      @default(true)
  // Relaciones
  rolPermisos RolPermiso[]

  @@map("auth_permisos")
}

model RolPermiso {
  id Int @id @default(autoincrement())

  rolId     Int
  permisoId Int
  // Relaciones
  rol       Rol     @relation(fields: [rolId], references: [id], onDelete: Cascade)
  permiso   Permiso @relation(fields: [permisoId], references: [id], onDelete: Cascade)

  @@unique([rolId, permisoId])
  @@map("auth_rol_permisos")
}

model Usuario {
  id                        String                     @id @default(cuid())
  email                     String                     @unique @db.VarChar(150)
  password                  String                     @db.VarChar(150)
  nombre                    String                     @db.VarChar(30)
  apellidos                 String                     @db.VarChar(30)
  telefono                  String?                    @db.VarChar(10)
  direccion                 String?
  avatar                    String?
  estaActivo                Boolean                    @default(true)
  emailVerificado           Boolean                    @default(false)
  twoFactorSecret           String?                    @db.VarChar(255)
  twoFactorEnabled          Boolean                    @default(false)
  fechaCreacion             DateTime                   @default(now())
  fechaActualizacion        DateTime                   @updatedAt
  // Relaciones de seguridad
  roles                     UsuarioRol[]
  sesiones                  Sesion[]
  historialLogins           HistorialLogin[]
  dispositivosConfianza     DispositivoConfianza[]
  tokensTemporales          TokenTemporal[]
  // Relaciones de negocio
  mensajesContacto          MensajeContacto[]
  historialEstadosServicios HistorialEstadosServicio[]
  responsableServicios      ResponsableServicio[]
  pagosIngresos             PagosIngresos[]
  gastos                    Gastos[]
  arqueosDiarios            ArqueosDiarios[]

  @@map("auth_usuarios")
}

model UsuarioRol {
  id        Int     @id @default(autoincrement())
  usuarioId String
  rolId     Int
  // Relaciones
  usuario   Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  rol       Rol     @relation(fields: [rolId], references: [id], onDelete: Cascade)

  @@unique([usuarioId, rolId])
  @@map("auth_usuario_roles")
}

model Sesion {
  id                 String   @id @default(cuid())
  usuarioId          String
  refreshToken       String   @unique
  userAgent          String?  @db.VarChar(500)
  ipAddress          String?  @db.VarChar(50)
  dispositivo        String?  @db.VarChar(255)
  navegador          String?  @db.VarChar(100)
  ubicacion          String?  @db.VarChar(255)
  estaActiva         Boolean  @default(true)
  fechaCreacion      DateTime @default(now())
  fechaExpiracion    DateTime
  ultimaActividad    DateTime @default(now())
  fechaActualizacion DateTime @updatedAt
  /// Relaciones
  usuario            Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@map("auth_sesiones")
}

model HistorialLogin {
  id           String   @id @default(cuid())
  usuarioId    String
  exitoso      Boolean
  ipAddress    String?  @db.VarChar(50)
  userAgent    String?  @db.VarChar(500)
  dispositivo  String?  @db.VarChar(255)
  navegador    String?  @db.VarChar(100)
  ubicacion    String?  @db.VarChar(255)
  motivoFallo  String?  @db.VarChar(255)
  fechaIntento DateTime @default(now())
  // Relaciones
  usuario      Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@map("auth_historial_login")
}

model DispositivoConfianza {
  id                String   @id @default(cuid())
  usuarioId         String
  deviceFingerprint String   @db.VarChar(255)
  deviceName        String?  @db.VarChar(255)
  userAgent         String?  @db.VarChar(500)
  navegador         String?  @db.VarChar(100)
  sistemaOperativo  String?  @db.VarChar(100)
  estaActivo        Boolean  @default(true)
  fechaCreacion     DateTime @default(now())
  fechaExpiracion   DateTime
  ultimoUso         DateTime @default(now())
  // Relaciones
  usuario           Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@unique([usuarioId, deviceFingerprint])
  @@map("auth_dispositivos_confianza")
}

model TokenTemporal {
  id              String   @id @default(cuid())
  clave           String // "verify_token", "reset_token", "otp_email", "2fa_secret"
  valor           String   @db.Text
  tipo            String // "verificacion_email", "reset_password", "otp_login", "2fa_setup"
  usuarioId       String
  metadatos       Json? // Para datos como { expiresAt, code, attempts }
  fechaExpiracion DateTime
  fechaCreacion   DateTime @default(now())
  // Relaciones
  usuario         Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@unique([usuarioId, tipo])
  @@index([usuarioId])
  @@index([fechaExpiracion])
  @@index([tipo])
  @@map("_tokens_temporales")
}

model ConfiguracionAplicacion {
  id                 String   @id @default(cuid())
  clave              String   @unique
  valor              String   @db.Text
  tipo               String   @default("texto") // "texto", "numero", "booleano", "json", "html"
  categoria          String   @default("general") // "sistema", "negocio", "politicas", "emails", "apariencia", "seguridad"
  descripcion        String?
  esEditable         Boolean  @default(true)
  fechaCreacion      DateTime @default(now())
  fechaActualizacion DateTime @updatedAt

  @@index([categoria])
  @@map("_configuracion_aplicacion")
}

// ============================================
// MÓDULO DE CATEGORÍAS
// ============================================

model Categoria {
  id                 String   @id @default(cuid())
  nombre             String   @unique
  descripcion        String?
  imagen             String?
  estaActiva         Boolean  @default(true)
  fechaCreacion      DateTime @default(now())
  fechaActualizacion DateTime @updatedAt

  @@map("cat_categorias")
}

// ============================================
// MÓDULO DE CONTACTO
// ============================================

model MensajeContacto {
  id                 String   @id @default(cuid())
  usuarioId          String? // opcional, puede ser un usuario anónimo
  nombre             String
  correo             String
  telefono           String?
  asunto             String
  mensaje            String
  categoria          String   @default("consulta") // "consulta", "queja", "sugerencia", "reclamo", "felicitacion", "otro"
  estado             String   @default("no_leido") // "no_leido", "leido", "en_proceso", "respondido", "cerrado"
  fechaCreacion      DateTime @default(now())
  fechaActualizacion DateTime @updatedAt

  // Relaciones
  usuario Usuario? @relation(fields: [usuarioId], references: [id])

  @@map("int_mensajes_contacto")
}

// ============================================
// MÓDULO DE CONFIGURACIÓN DEL SISTEMA
// ============================================

// ============================================================================
// BANKING
// ============================================================================

model Banco {
  id     Int    @id @default(autoincrement())
  nombre String @db.VarChar(100)

  cuentasBancarias CuentaBancaria[] @relation(name: "BancoCuenta")

  @@map("bancos")
}

model CuentaBancaria {
  id           Int     @id @default(autoincrement())
  bancoId      Int
  numeroCuenta String  @db.VarChar(50)
  tipoCuenta   String? @db.VarChar(50)
  saldoActual  Decimal @default(0.00) @db.Decimal(12, 2)

  banco                Banco                  @relation(name: "BancoCuenta", fields: [bancoId], references: [id])
  pagosIngresos        PagosIngresos[]
  transaccionesEgresos TransaccionesEgresos[]

  @@map("cuentas_bancarias")
}

// ============================================================================
// DOCUMENTS
// ============================================================================

model TipoDocumento {
  id         Int     @id @default(autoincrement())
  nombre     String  @db.VarChar(100)
  precioBase Decimal @default(0.00) @db.Decimal(10, 2)

  plantillasDocumento PlantillaDocumento[]
  servicios           Servicio[]

  @@map("tipos_documento")
}

model PlantillaDocumento {
  id              Int     @id @default(autoincrement())
  tipoDocumentoId Int
  nombrePlantilla String? @db.VarChar(100)
  contenidoHtml   String? @db.Text

  tipoDocumento TipoDocumento @relation(fields: [tipoDocumentoId], references: [id])

  @@map("plantillas_documento")
}

model EstadoTramite {
  id       Int     @id @default(autoincrement())
  nombre   String  @db.VarChar(50)
  colorHex String? @db.VarChar(10)

  historialEstadosServicio HistorialEstadosServicio[]

  @@map("estados_tramite")
}

// ============================================================================
// CLIENTS
// ============================================================================

model Cliente {
  id            Int             @id @default(autoincrement())
  tipo          TipoClienteEnum
  direccion     String?         @db.VarChar(255)
  telefono      String?         @db.VarChar(20)
  email         String?         @db.VarChar(100)
  fechaRegistro DateTime        @default(now()) @db.Timestamptz()

  personaNatural  PersonaNatural?
  personaJuridica PersonaJuridica?
  servicios       Servicio[]

  @@map("clientes")
}

model PersonaNatural {
  clienteId       Int       @id
  ci              String?   @unique @db.VarChar(20)
  expedido        String?   @db.VarChar(10)
  nombres         String    @db.VarChar(100)
  apellidos       String    @db.VarChar(100)
  fechaNacimiento DateTime? @db.Date

  cliente Cliente @relation(fields: [clienteId], references: [id], onDelete: Cascade)

  @@map("personas_naturales")
}

model PersonaJuridica {
  clienteId          Int     @id
  nit                String? @unique @db.VarChar(20)
  razonSocial        String  @db.VarChar(150)
  representanteLegal String? @db.VarChar(150)

  cliente Cliente @relation(fields: [clienteId], references: [id], onDelete: Cascade)

  @@map("personas_juridicas")
}

// ============================================================================
// SERVICES & WORKFLOW
// ============================================================================

model Servicio {
  id              Int      @id @default(autoincrement())
  codigoTicket    String   @unique @db.VarChar(20)
  clienteId       Int
  tipoDocumentoId Int
  claseTramite    String?  @db.VarChar(50)
  tipoTramite     String?  @db.VarChar(50)
  negocio         String?  @db.VarChar(50)
  fechaInicio     DateTime @default(now()) @db.Timestamptz()
  observaciones   String?  @db.Text
  contenidoFinal  String?  @db.Text
  montoTotal      Decimal  @db.Decimal(10, 2)
  saldoPendiente  Decimal  @db.Decimal(10, 2)

  cliente                  Cliente                    @relation(fields: [clienteId], references: [id])
  tipoDocumento            TipoDocumento              @relation(fields: [tipoDocumentoId], references: [id])
  historialEstadosServicio HistorialEstadosServicio[]
  responsablesServicio     ResponsableServicio[]
  pagosIngresos            PagosIngresos[]

  @@map("servicios")
}

model HistorialEstadosServicio {
  id          Int      @id @default(autoincrement())
  usuarioId   String?
  servicioId  Int
  estadoId    Int
  fechaCambio DateTime @default(now()) @db.Timestamptz()
  comentario  String?  @db.VarChar(255)

  usuario  Usuario?      @relation(fields: [usuarioId], references: [id])
  servicio Servicio      @relation(fields: [servicioId], references: [id], onDelete: Cascade)
  estado   EstadoTramite @relation(fields: [estadoId], references: [id])

  @@map("historial_estados_servicio")
}

model ResponsableServicio {
  id              Int       @id @default(autoincrement())
  usuarioId       String
  servicioId      Int
  fechaAsignacion DateTime  @default(now()) @db.Timestamptz()
  fechaBaja       DateTime?
  activo          Boolean   @default(true)

  usuario  Usuario  @relation(fields: [usuarioId], references: [id])
  servicio Servicio @relation(fields: [servicioId], references: [id], onDelete: Cascade)

  @@map("responsables_servicio")
}

// ============================================================================
// PAYMENTS & INCOME
// ============================================================================

model PagosIngresos {
  id                Int             @id @default(autoincrement())
  servicioId        Int?
  fecha             DateTime        @default(now()) @db.Timestamptz()
  monto             Decimal         @db.Decimal(10, 2)
  tipoPago          MetodoPagoEnum
  cuentaBancariaId  Int?
  constanciaTipo    ConstanciaEnum?
  numeroConstancia  String?         @db.VarChar(50)
  concepto          String?         @db.VarChar(255)
  usuarioRegistroId String?

  servicio        Servicio?       @relation(fields: [servicioId], references: [id])
  cuentaBancaria  CuentaBancaria? @relation(fields: [cuentaBancariaId], references: [id])
  usuarioRegistro Usuario?        @relation(fields: [usuarioRegistroId], references: [id])

  @@map("pagos_ingresos")
}

// ============================================================================
// EXPENSES & DISBURSEMENTS
// ============================================================================

model Gastos {
  id          Int      @id @default(autoincrement())
  nombre      String   @db.VarChar(100)
  descripcion String?  @db.Text
  proveedor   String?  @db.VarChar(100)
  montoTotal  Decimal  @db.Decimal(10, 2)
  montoPagado Decimal  @default(0) @db.Decimal(10, 2)
  saldo       Decimal? @db.Decimal(10, 2)
  fechaGasto  DateTime @default(now()) @db.Date
  categoria   String?  @db.VarChar(50)
  usuarioId   String?

  usuario              Usuario?               @relation(fields: [usuarioId], references: [id])
  transaccionesEgresos TransaccionesEgresos[]

  @@map("gastos")
}

model TransaccionesEgresos {
  id               Int            @id @default(autoincrement())
  gastoId          Int
  monto            Decimal        @db.Decimal(10, 2)
  fecha            DateTime       @default(now()) @db.Timestamptz()
  cuentaBancariaId Int?
  metodoPago       MetodoPagoEnum

  gasto          Gastos          @relation(fields: [gastoId], references: [id])
  cuentaBancaria CuentaBancaria? @relation(fields: [cuentaBancariaId], references: [id])

  @@map("transacciones_egresos")
}

// ============================================================================
// DAILY RECONCILIATION
// ============================================================================

model ArqueosDiarios {
  id                    Int      @id @default(autoincrement())
  fecha                 DateTime @unique @default(now()) @db.Date
  usuarioCierreId       String?
  totalIngresosEfectivo Decimal  @default(0) @db.Decimal(10, 2)
  totalIngresosBancos   Decimal  @default(0) @db.Decimal(10, 2)
  totalEgresosEfectivo  Decimal  @default(0) @db.Decimal(10, 2)
  totalEgresosBancos    Decimal  @default(0) @db.Decimal(10, 2)
  saldoFinalDia         Decimal  @default(0) @db.Decimal(10, 2)
  observaciones         String?  @db.Text
  fechaCierre           DateTime @default(now()) @db.Timestamptz()

  usuarioCierre Usuario? @relation(fields: [usuarioCierreId], references: [id])

  @@map("arqueos_diarios")
}
