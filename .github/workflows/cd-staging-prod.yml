env:
jobs:

name: CD - Staging + Production

on:
  push:
    branches: ['main']
    tags: ['v*']
  workflow_dispatch:

env:
  RELEASE_DIR: /var/www/backend-ntr/releases
  SHARED_DIR: /var/www/backend-ntr/shared

jobs:
  deploy_staging:
    name: Deploy to Staging
    if: github.ref == 'refs/heads/main'
    runs-on: self-hosted
    environment:
      name: staging
    steps:
      - uses: actions/checkout@v4

      - name: Download backend artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-build
          path: ./artifact

      - name: Create RELEASE_ID
        run: |
          RELEASE_ID=$(date +"%Y%m%d_%H%M%S")-$(echo ${GITHUB_SHA} | cut -c1-7)
          echo $RELEASE_ID > ./artifact/RELEASE_ID

      - name: Deploy backend to staging
        env:
          STAGING_HOST: ${{ secrets.STAGING_HOST }}
          STAGING_USER: ${{ secrets.STAGING_USER }}
          STAGING_SSH_KEY: ${{ secrets.STAGING_SSH_KEY }}
          STAGING_PORT: ${{ secrets.STAGING_PORT || 2222 }}
        shell: pwsh
        run: |
          # Similar al original, pero usando artefacto descargado
          # (Código abreviado para brevedad, pero mantén la lógica de SSH, tar, deploy, health check)

  deploy_production:
    name: Deploy to Production
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    runs-on: self-hosted
    environment:
      name: production
    steps:
      - uses: actions/checkout@v4

      - name: Download backend artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-build
          path: ./artifact

      - name: Create RELEASE_ID
        run: |
          RELEASE_ID=$(date +"%Y%m%d_%H%M%S")-$(echo ${GITHUB_SHA} | cut -c1-7)
          echo $RELEASE_ID > ./artifact/RELEASE_ID

      - name: Deploy backend to production
        env:
          PROD_HOST: ${{ secrets.PROD_HOST }}
          PROD_USER: ${{ secrets.PROD_USER }}
          PROD_SSH_KEY: ${{ secrets.PROD_SSH_KEY }}
          PROD_PORT: ${{ secrets.PROD_PORT || 2223 }}
        shell: pwsh
        run: |
          # Similar al original para prod

  rollback_staging:
    if: failure() && github.ref == 'refs/heads/main'
    runs-on: self-hosted
    needs: [deploy_staging]
    steps:
      # Rollback logic

  rollback_production:
    if: failure() && (startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch')
    runs-on: self-hosted
    needs: [deploy_production]
    steps:
      # Rollback logic
