name: CD - Staging + Production

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:

env:
  RELEASE_DIR: /var/www/backend-ntr/releases
  SHARED_DIR: /var/www/backend-ntr/shared

jobs:
  build:
    name: ðŸ—ï¸ Build Artifact
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ðŸ“¦ Install dependencies
        run: yarn install --frozen-lockfile

      - name: ðŸ”§ Generate Prisma client
        run: npx prisma generate
        env:
          DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy

      - name: ðŸ—ï¸ Build backend
        run: yarn build

      - name: ðŸ“¦ Compress build artifact
        run: |
          tar -czf backend-build.tar.gz \
            dist/ \
            node_modules/ \
            package.json \
            yarn.lock \
            prisma/ \
            src/generated/

      - name: ðŸ“¤ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-build
          path: backend-build.tar.gz
          retention-days: 7

  deploy_staging:
    name: Deploy to Staging
    if: github.ref == 'refs/heads/main'
    runs-on: self-hosted
    environment:
      name: staging
    needs: [build]
    steps:
      - uses: actions/checkout@v4

      - name: Download backend artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-build
          path: ./artifact

      - name: Extract artifact
        run: tar -xzf ./artifact/backend-build.tar.gz -C ./artifact

      - name: Create RELEASE_ID
        run: |
          RELEASE_ID=$(date +"%Y%m%d_%H%M%S")-$(echo ${GITHUB_SHA} | cut -c1-7)
          echo $RELEASE_ID > ./artifact/RELEASE_ID

      - name: Deploy backend to staging
        env:
          STAGING_HOST: ${{ secrets.STAGING_HOST }}
          STAGING_USER: ${{ secrets.STAGING_USER }}
          STAGING_SSH_KEY: ${{ secrets.STAGING_SSH_KEY }}
          STAGING_PORT: ${{ secrets.STAGING_PORT || 2222 }}
        shell: bash
        run: |
          ssh_dir="$HOME/.ssh"
          mkdir -p "$ssh_dir"
          remote_host="${STAGING_HOST//[@:]*/}"
          remote_user="${STAGING_USER//[@:]*/}"
          if [ -z "$remote_host" ] || [ -z "$remote_user" ]; then
            echo "STAGING_HOST or STAGING_USER is empty"
            exit 1
          fi
          remote="$remote_user@$remote_host"
          echo "$STAGING_SSH_KEY" > "$ssh_dir/deploy_key"
          chmod 600 "$ssh_dir/deploy_key"
          RELEASE=$(cat ./artifact/RELEASE_ID)
          echo "Creating release directory..."
          ssh -i "$ssh_dir/deploy_key" -p "${STAGING_PORT:-2222}" -o StrictHostKeyChecking=no -o BatchMode=yes -o IdentitiesOnly=yes -o PreferredAuthentications=publickey -o ConnectTimeout=10 -o ServerAliveInterval=5 -o ServerAliveCountMax=3 "$remote" "mkdir -p /var/www/backend-ntr/releases/$RELEASE"
          if [ $? -ne 0 ]; then
            echo "Failed to create release directory"
            exit 1
          fi
          echo "Copying files..."
          archive="artifact-$RELEASE.tgz"
          tar -czf "$archive" -C ./artifact .
          scp -i "$ssh_dir/deploy_key" -P "${STAGING_PORT:-2222}" -o StrictHostKeyChecking=no -o BatchMode=yes -o IdentitiesOnly=yes -o PreferredAuthentications=publickey -o ConnectTimeout=10 "$archive" "$remote:/var/www/backend-ntr/releases/$RELEASE/"
          if [ $? -ne 0 ]; then
            echo "Failed to copy files"
            exit 1
          fi
          echo "Running migrations and switching symlink..."
          deploy_sh="deploy-$RELEASE.sh"
          cat > "$deploy_sh" << 'EOF'
          set -euo pipefail
          cd "/var/www/backend-ntr/releases/'$RELEASE'"
          tar -xzf "'$archive'"
          rm -f "'$archive'"
          ln -sfn /var/www/backend-ntr/shared/.env .env
          
          export NODE_ENV=staging
          export RELEASE_ID='$RELEASE'
          
          echo "Node version:"
          node -v
          major=$(node -p "parseInt(process.versions.node.split('.')[0],10)")
          if [ "$major" -lt 18 ]; then echo "Node >=18 required for Prisma" >&2; exit 1; fi
          if [ -f "./node_modules/prisma/build/index.js" ]; then
            node ./node_modules/prisma/build/index.js migrate deploy
          else
            echo "Prisma package not found in node_modules (node_modules/prisma/build/index.js missing)" >&2
            exit 1
          fi
          
          ln -sfn "/var/www/backend-ntr/releases/'$RELEASE'" /var/www/backend-ntr/current
          
          # Start or restart the app with pm2 (best-effort for local staging container)
          cd /var/www/backend-ntr/current
          if ! command -v pm2 >/dev/null 2>&1; then
            yarn global add pm2
          fi
          pm2 start dist/main.js --name backend-ntr-api --update-env --time || pm2 restart backend-ntr-api --update-env
          EOF
          scp -i "$ssh_dir/deploy_key" -P "${STAGING_PORT:-2222}" -o StrictHostKeyChecking=no -o BatchMode=yes -o IdentitiesOnly=yes -o PreferredAuthentications=publickey -o ConnectTimeout=10 "$deploy_sh" "$remote:/var/www/backend-ntr/releases/$RELEASE/"
          if [ $? -ne 0 ]; then
            echo "Failed to copy deploy script"
            exit 1
          fi
          ssh -i "$ssh_dir/deploy_key" -p "${STAGING_PORT:-2222}" -o StrictHostKeyChecking=no -o BatchMode=yes -o IdentitiesOnly=yes -o PreferredAuthentications=publickey -o ConnectTimeout=10 -o ServerAliveInterval=5 -o ServerAliveCountMax=3 "$remote" "bash /var/www/backend-ntr/releases/$RELEASE/$deploy_sh"
          if [ $? -ne 0 ]; then
            echo "Failed to deploy"
            exit 1
          fi
          rm -f "$deploy_sh"
          echo "Deployment completed successfully"

      - name: Health check staging
        env:
          STAGING_APP_URL: ${{ secrets.STAGING_APP_URL }}
        shell: bash
        run: |
          sleep 5
          base_url="${STAGING_APP_URL%/}"
          if [[ "$base_url" == */api ]]; then
            url="$base_url/health"
          else
            url="$base_url/api/health"
          fi
          echo "Health check URL: $url"
          if ! curl -f "$url"; then
            echo "Health check failed"
            exit 1
          fi

  rollback_staging:
    name: Rollback Staging
    if: failure() && github.ref == 'refs/heads/main'
    runs-on: self-hosted
    needs: [deploy_staging]
    environment:
      name: staging
    steps:
      - name: Rollback to previous release
        env:
          STAGING_HOST: ${{ secrets.STAGING_HOST }}
          STAGING_USER: ${{ secrets.STAGING_USER }}
          STAGING_SSH_KEY: ${{ secrets.STAGING_SSH_KEY }}
          STAGING_PORT: ${{ secrets.STAGING_PORT || 2222 }}
        shell: bash
        run: |
          ssh_dir="$HOME/.ssh"
          mkdir -p "$ssh_dir"
          remote_host="${STAGING_HOST//[@:]*/}"
          remote_user="${STAGING_USER//[@:]*/}"
          remote="$remote_user@$remote_host"
          echo "$STAGING_SSH_KEY" > "$ssh_dir/deploy_key"
          chmod 600 "$ssh_dir/deploy_key"
          rollback_cmd='set -e; PREV=$(ls -1dt /var/www/backend-ntr/releases/*/ 2>/dev/null | sed -n "2p" | tr -d "/"); if [ -n "$PREV" ]; then echo "Rolling back to: $PREV"; ln -sfn "$PREV" /var/www/backend-ntr/current; if command -v pm2 >/dev/null 2>&1; then pm2 restart backend-ntr-api --update-env || true; fi; else echo "No previous release found for rollback"; exit 1; fi'
          ssh -i "$ssh_dir/deploy_key" -p "${STAGING_PORT:-2222}" -o StrictHostKeyChecking=no -o BatchMode=yes -o IdentitiesOnly=yes -o PreferredAuthentications=publickey -o ConnectTimeout=10 -o ServerAliveInterval=5 -o ServerAliveCountMax=3 "$remote" "$rollback_cmd"

  deploy_production:
    name: Deploy to Production
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    runs-on: self-hosted
    environment:
      name: production
    needs: [build, deploy_staging]
    steps:
      - uses: actions/checkout@v4

      - name: Download backend artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-build
          path: ./artifact

      - name: Extract artifact
        run: tar -xzf ./artifact/backend-build.tar.gz -C ./artifact

      - name: Create RELEASE_ID
        run: |
          RELEASE_ID=$(date +"%Y%m%d_%H%M%S")-$(echo ${GITHUB_SHA} | cut -c1-7)
          echo $RELEASE_ID > ./artifact/RELEASE_ID

      - name: Deploy backend to production
        env:
          PROD_HOST: ${{ secrets.PROD_HOST }}
          PROD_USER: ${{ secrets.PROD_USER }}
          PROD_SSH_KEY: ${{ secrets.PROD_SSH_KEY }}
          PROD_PORT: ${{ secrets.PROD_PORT || 2223 }}
        shell: bash
        run: |
          ssh_dir="$HOME/.ssh"
          mkdir -p "$ssh_dir"
          remote_host="${PROD_HOST//[@:]*/}"
          remote_user="${PROD_USER//[@:]*/}"
          if [ -z "$remote_host" ] || [ -z "$remote_user" ]; then
            echo "PROD_HOST or PROD_USER is empty"
            exit 1
          fi
          remote="$remote_user@$remote_host"
          echo "$PROD_SSH_KEY" > "$ssh_dir/deploy_key"
          chmod 600 "$ssh_dir/deploy_key"
          RELEASE=$(cat ./artifact/RELEASE_ID)
          echo "Creating release directory..."
          ssh -i "$ssh_dir/deploy_key" -p "${PROD_PORT:-2223}" -o StrictHostKeyChecking=no -o BatchMode=yes -o IdentitiesOnly=yes -o PreferredAuthentications=publickey -o ConnectTimeout=10 -o ServerAliveInterval=5 -o ServerAliveCountMax=3 "$remote" "mkdir -p /var/www/backend-ntr/releases/$RELEASE"
          if [ $? -ne 0 ]; then
            echo "Failed to create release directory"
            exit 1
          fi
          echo "Copying files..."
          archive="artifact-$RELEASE.tgz"
          tar -czf "$archive" -C ./artifact .
          scp -i "$ssh_dir/deploy_key" -P "${PROD_PORT:-2223}" -o StrictHostKeyChecking=no -o BatchMode=yes -o IdentitiesOnly=yes -o PreferredAuthentications=publickey -o ConnectTimeout=10 "$archive" "$remote:/var/www/backend-ntr/releases/$RELEASE/"
          if [ $? -ne 0 ]; then
            echo "Failed to copy files"
            exit 1
          fi
          echo "Running migrations and switching symlink..."
          deploy_sh="deploy-$RELEASE.sh"
          cat > "$deploy_sh" << 'EOF'
          set -euo pipefail
          cd "/var/www/backend-ntr/releases/'$RELEASE'"
          tar -xzf "'$archive'"
          rm -f "'$archive'"
          ln -sfn /var/www/backend-ntr/shared/.env .env
          
          export NODE_ENV=production
          export RELEASE_ID='$RELEASE'
          
          echo "Node version:"
          node -v
          major=$(node -p "parseInt(process.versions.node.split('.')[0],10)")
          if [ "$major" -lt 18 ]; then echo "Node >=18 required for Prisma" >&2; exit 1; fi
          if [ -f "./node_modules/prisma/build/index.js" ]; then
            node ./node_modules/prisma/build/index.js migrate deploy
          else
            echo "Prisma package not found in node_modules (node_modules/prisma/build/index.js missing)" >&2
            exit 1
          fi
          
          ln -sfn "/var/www/backend-ntr/releases/'$RELEASE'" /var/www/backend-ntr/current
          
          # Start or restart the app with pm2
          cd /var/www/backend-ntr/current
          if ! command -v pm2 >/dev/null 2>&1; then
            yarn global add pm2
          fi
          pm2 start dist/main.js --name backend-ntr-api --update-env --time || pm2 restart backend-ntr-api --update-env
          EOF
          scp -i "$ssh_dir/deploy_key" -P "${PROD_PORT:-2223}" -o StrictHostKeyChecking=no -o BatchMode=yes -o IdentitiesOnly=yes -o PreferredAuthentications=publickey -o ConnectTimeout=10 "$deploy_sh" "$remote:/var/www/backend-ntr/releases/$RELEASE/"
          if [ $? -ne 0 ]; then
            echo "Failed to copy deploy script"
            exit 1
          fi
          ssh -i "$ssh_dir/deploy_key" -p "${PROD_PORT:-2223}" -o StrictHostKeyChecking=no -o BatchMode=yes -o IdentitiesOnly=yes -o PreferredAuthentications=publickey -o ConnectTimeout=10 -o ServerAliveInterval=5 -o ServerAliveCountMax=3 "$remote" "bash /var/www/backend-ntr/releases/$RELEASE/$deploy_sh"
          if [ $? -ne 0 ]; then
            echo "Failed to deploy"
            exit 1
          fi
          rm -f "$deploy_sh"
          echo "Deployment completed successfully"

      - name: Health check production
        env:
          PROD_APP_URL: ${{ secrets.PROD_APP_URL }}
        shell: bash
        run: |
          sleep 5
          base_url="${PROD_APP_URL%/}"
          if [[ "$base_url" == */api ]]; then
            url="$base_url/health"
          else
            url="$base_url/api/health"
          fi
          echo "Health check URL: $url"
          if ! curl -f "$url"; then
            echo "Health check failed"
            exit 1
          fi

  rollback_production:
    name: Rollback Production
    if: failure() && (startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch')
    runs-on: self-hosted
    needs: [deploy_production]
    environment:
      name: production
    steps:
      - name: Rollback to previous release
        env:
          PROD_HOST: ${{ secrets.PROD_HOST }}
          PROD_USER: ${{ secrets.PROD_USER }}
          PROD_SSH_KEY: ${{ secrets.PROD_SSH_KEY }}
          PROD_PORT: ${{ secrets.PROD_PORT || 2223 }}
        shell: bash
        run: |
          ssh_dir="$HOME/.ssh"
          mkdir -p "$ssh_dir"
          remote_host="${PROD_HOST//[@:]*/}"
          remote_user="${PROD_USER//[@:]*/}"
          remote="$remote_user@$remote_host"
          echo "$PROD_SSH_KEY" > "$ssh_dir/deploy_key"
          chmod 600 "$ssh_dir/deploy_key"
          rollback_cmd='set -e; PREV=$(ls -1dt /var/www/backend-ntr/releases/*/ 2>/dev/null | sed -n "2p" | tr -d "/"); if [ -n "$PREV" ]; then echo "Rolling back to: $PREV"; ln -sfn "$PREV" /var/www/backend-ntr/current; if command -v pm2 >/dev/null 2>&1; then pm2 restart backend-ntr-api --update-env || true; fi; else echo "No previous release found for rollback"; exit 1; fi'
          ssh -i "$ssh_dir/deploy_key" -p "${PROD_PORT:-2223}" -o StrictHostKeyChecking=no -o BatchMode=yes -o IdentitiesOnly=yes -o PreferredAuthentications=publickey -o ConnectTimeout=10 -o ServerAliveInterval=5 -o ServerAliveCountMax=3 "$remote" "$rollback_cmd"
