name: CD - Staging and Production

on:
  push:
    branches: ['main']
    tags: ['v*']
  workflow_dispatch:

env:
  RELEASE_DIR: /var/www/backend-ntr/releases
  SHARED_DIR: /var/www/backend-ntr/shared

jobs:
  validate:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: yarn install --frozen-lockfile
      - name: Lint
        run: yarn lint
      - name: Test
        run: yarn test

  build:
    needs: [validate]
    runs-on: self-hosted
    outputs:
      release_id: ${{ steps.set-release.outputs.release_id }}
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: yarn install --frozen-lockfile
      - name: Build
        run: yarn build
      - name: Set release id
        id: set-release
        run: |
          RELEASE_ID=$(date +"%Y%m%d_%H%M%S")-$(echo ${GITHUB_SHA} | cut -c1-7)
          echo "release_id=$RELEASE_ID" >> $GITHUB_OUTPUT
      - name: Pack artifact
        run: |
          RELEASE=${{ steps.set-release.outputs.release_id }}
          mkdir -p ./release
          # Exclude node_modules to keep artifact small
          tar -czf ./release/release-${RELEASE}.tar.gz dist package.json yarn.lock prisma RELEASE_ID
      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ steps.set-release.outputs.release_id }}
          path: ./release/release-*.tar.gz

  deploy_staging:
    if: github.ref == 'refs/heads/main'
    runs-on: self-hosted
    needs: [build]
    environment: staging
    steps:
      - uses: actions/checkout@v4
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: release-${{ needs.build.outputs.release_id }}
          path: ./release
      - name: Deploy to staging via SSH
        env:
          RELEASE: ${{ needs.build.outputs.release_id }}
          SSH_PORT: ${{ secrets.STAGING_PORT || 2222 }}
          SSH_HOST: ${{ secrets.STAGING_HOST || 'localhost' }}
          SSH_USER: ${{ secrets.STAGING_USER || 'deploy' }}
        run: |
          tar -xzf ./release/release-${RELEASE}.tar.gz -C ./release-dir || true

          # Ensure release directory exists
          ssh -p $SSH_PORT -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "mkdir -p ${RELEASE_DIR}/${RELEASE}"

          # RSYNC artifact
          rsync -avz -e "ssh -p $SSH_PORT -o StrictHostKeyChecking=no" --delete ./release-dir/ $SSH_USER@$SSH_HOST:${RELEASE_DIR}/${RELEASE}/

          # Remote setup
          ssh -p $SSH_PORT -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "
            cd ${RELEASE_DIR}/${RELEASE} && 
            yarn install --production --frozen-lockfile && 
            # We assume shared/.env exists and we source it or link it
            if [ -f ${SHARED_DIR}/.env ]; then cp ${SHARED_DIR}/.env ./.env; fi &&
            npx prisma migrate deploy && 
            ln -sfn ${RELEASE_DIR}/${RELEASE} /var/www/backend-ntr/current &&
            echo 'Deployed ${RELEASE}'
          "
      - name: Health check staging
        run: |
          sleep 5
          curl -f "${{ secrets.STAGING_APP_URL || 'http://localhost:3001' }}/api/health"

  deploy_production:
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    runs-on: self-hosted
    needs: [deploy_staging]
    environment: production
    steps:
      - uses: actions/checkout@v4
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: release-${{ needs.build.outputs.release_id }}
          path: ./release
      - name: Deploy to production via SSH
        env:
          RELEASE: ${{ needs.build.outputs.release_id }}
          SSH_PORT: ${{ secrets.PROD_PORT || 2223 }}
          SSH_HOST: ${{ secrets.PROD_HOST || 'localhost' }}
          SSH_USER: ${{ secrets.PROD_USER || 'deploy' }}
        run: |
          tar -xzf ./release/release-${RELEASE}.tar.gz -C ./release-dir || true

          ssh -p $SSH_PORT -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "mkdir -p ${RELEASE_DIR}/${RELEASE}"

          rsync -avz -e "ssh -p $SSH_PORT -o StrictHostKeyChecking=no" --delete ./release-dir/ $SSH_USER@$SSH_HOST:${RELEASE_DIR}/${RELEASE}/

          ssh -p $SSH_PORT -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "
            cd ${RELEASE_DIR}/${RELEASE} && 
            yarn install --production --frozen-lockfile && 
            if [ -f ${SHARED_DIR}/.env ]; then cp ${SHARED_DIR}/.env ./.env; fi &&
            npx prisma migrate deploy && 
            ln -sfn ${RELEASE_DIR}/${RELEASE} /var/www/backend-ntr/current &&
            echo 'Deployed ${RELEASE}'
          "
      - name: Health check production
        run: |
          sleep 5
          curl -f "${{ secrets.PROD_APP_URL || 'http://localhost:3002' }}/api/health"

  rollback_staging:
    if: failure() && needs.deploy_staging.result == 'failure'
    runs-on: self-hosted
    needs: [deploy_staging]
    steps:
      - name: Rollback staging
        env:
          SSH_PORT: ${{ secrets.STAGING_PORT || 2222 }}
          SSH_HOST: ${{ secrets.STAGING_HOST || 'localhost' }}
          SSH_USER: ${{ secrets.STAGING_USER || 'deploy' }}
        run: |
          ssh -p $SSH_PORT -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "
            PREV=\$(ls -1dt ${RELEASE_DIR}/*/ | sed -n '2p' | tr -d '/')
            if [ -n \"\$PREV\" ]; then
              ln -sfn \$PREV /var/www/backend-ntr/current
              echo \"Rolled back to \$PREV\"
            else
              echo \"No previous release found\"
            fi
          "

  rollback_production:
    if: failure() && needs.deploy_production.result == 'failure'
    runs-on: self-hosted
    needs: [deploy_production]
    steps:
      - name: Rollback production
        env:
          SSH_PORT: ${{ secrets.PROD_PORT || 2223 }}
          SSH_HOST: ${{ secrets.PROD_HOST || 'localhost' }}
          SSH_USER: ${{ secrets.PROD_USER || 'deploy' }}
        run: |
          ssh -p $SSH_PORT -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "
            PREV=\$(ls -1dt ${RELEASE_DIR}/*/ | sed -n '2p' | tr -d '/')
            if [ -n \"\$PREV\" ]; then
              ln -sfn \$PREV /var/www/backend-ntr/current
              echo \"Rolled back to \$PREV\"
            else
              echo \"No previous release found\"
            fi
          "
