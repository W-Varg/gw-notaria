name: CD - Staging and Production

on:
  push:
    branches: ["main"]
    tags: ["v*"]
  workflow_dispatch:

env:
  RELEASE_DIR: /var/www/backend_notaria/releases

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.set-release.outputs.release_id }}
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: yarn install --frozen-lockfile
      - name: Build
        run: yarn build
      - name: Set release id
        id: set-release
        run: |
          RELEASE_ID=$(date +"%Y%m%d_%H%M%S")-$(echo ${GITHUB_SHA} | cut -c1-7)
          echo "release_id=$RELEASE_ID" >> $GITHUB_OUTPUT
      - name: Pack artifact
        run: |
          RELEASE=${{ steps.set-release.outputs.release_id }}
          mkdir -p ./release
          tar -czf ./release/release-${RELEASE}.tar.gz dist package.json yarn.lock prisma
      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ steps.set-release.outputs.release_id }}
          path: ./release/release-*.tar.gz

  deploy_staging:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: [build]
    environment: staging
    steps:
      - uses: actions/checkout@v4
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: release-${{ needs.build.outputs.release_id }}
          path: ./release
      - name: Deploy to staging via SSH
        env:
          RELEASE: ${{ needs.build.outputs.release_id }}
        run: |
          tar -xzf ./release/release-${RELEASE}.tar.gz -C ./release-dir || true
          ssh -o StrictHostKeyChecking=no ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }} "mkdir -p ${RELEASE_DIR}/${RELEASE}"
          rsync -avz --delete ./release-dir/ ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }}:${RELEASE_DIR}/${RELEASE}/
          ssh -o StrictHostKeyChecking=no ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }} "cd ${RELEASE_DIR}/${RELEASE} && yarn install --production --frozen-lockfile || true && npx prisma migrate deploy || true && ln -sfn ${RELEASE_DIR}/${RELEASE} /var/www/backend_notaria/current"
      - name: Health check staging
        run: |
          curl -f "${{ secrets.STAGING_APP_URL }}/api/health"

  deploy_production:
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    needs: [deploy_staging]
    environment: production
    steps:
      - uses: actions/checkout@v4
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: release-${{ needs.build.outputs.release_id }}
          path: ./release
      - name: Deploy to production via SSH
        env:
          RELEASE: ${{ needs.build.outputs.release_id }}
        run: |
          tar -xzf ./release/release-${RELEASE}.tar.gz -C ./release-dir || true
          ssh -o StrictHostKeyChecking=no ${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }} "mkdir -p ${RELEASE_DIR}/${RELEASE}"
          rsync -avz --delete ./release-dir/ ${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }}:${RELEASE_DIR}/${RELEASE}/
          ssh -o StrictHostKeyChecking=no ${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }} "cd ${RELEASE_DIR}/${RELEASE} && yarn install --production --frozen-lockfile || true && npx prisma migrate deploy || true && ln -sfn ${RELEASE_DIR}/${RELEASE} /var/www/backend_notaria/current"
      - name: Health check production
        run: |
          curl -f "${{ secrets.PROD_APP_URL }}/api/health"

  rollback_on_failure:
    if: failure()
    runs-on: ubuntu-latest
    needs: [deploy_staging, deploy_production]
    steps:
      - name: Rollback staging (best-effort)
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }} "PREV=$(ls -1dt ${RELEASE_DIR}/*/ | sed -n '2p' | tr -d '/') && [ -n \"$PREV\" ] && ln -sfn $PREV /var/www/backend_notaria/current || true"
      - name: Rollback production (best-effort)
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }} "PREV=$(ls -1dt ${RELEASE_DIR}/*/ | sed -n '2p' | tr -d '/') && [ -n \"$PREV\" ] && ln -sfn $PREV /var/www/backend_notaria/current || true"
