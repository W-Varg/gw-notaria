# ============================================================================
# GitHub Actions CI Pipeline for NestJS Backend
# ============================================================================
# Este workflow ejecuta quality gates, tests y build para el backend NestJS
# Se ejecuta en push a dev/main y PRs
# ============================================================================

name: CI

# ============================================================================
# TRIGGERS: CuÃ¡ndo se ejecuta el workflow
# ============================================================================
on:
  push:
    branches: [ main, dev ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, dev ]

# ============================================================================
# JOBS: Tareas que se ejecutan en paralelo
# ============================================================================
jobs:
  # ==========================================================================
  # JOB 1: LINT (ESLint)
  # ==========================================================================
  lint:
    name: ğŸ” Lint (ESLint)
    runs-on: self-hosted
    environment: ci
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ Install dependencies
        run: yarn install --frozen-lockfile

      - name: ğŸ”§ Generate Prisma client
        run: npx prisma generate
        env:
          DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy

      - name: âœ¨ Run ESLint
        run: yarn lint

  # ==========================================================================
  # JOB 2: TESTS (Jest)
  # ==========================================================================
  test:
    name: ğŸ§ª Tests (Jest)
    runs-on: self-hosted
    environment: ci
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ Install dependencies
        run: yarn install --frozen-lockfile

      - name: ğŸ”§ Generate Prisma client
        run: npx prisma generate
        env:
          DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy

      - name: ğŸ§ª Run tests
        run: yarn test

  # ==========================================================================
  # JOB 3: BUILD
  # ==========================================================================
  build:
    name: ğŸ—ï¸ Build
    runs-on: self-hosted
    environment: ci
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ Install dependencies
        run: yarn install --frozen-lockfile

      - name: ğŸ”§ Generate Prisma client
        run: npx prisma generate
        env:
          DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy

      - name: ğŸ—ï¸ Build backend
        run: yarn build

      - name: ğŸ“¦ Compress build artifact
        run: |
          tar -czf backend-build.tar.gz \
            dist/ \
            node_modules/ \
            package.json \
            yarn.lock \
            prisma/ \
            src/generated/

      - name: ğŸ“¤ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-build
          path: backend-build.tar.gz
          retention-days: 7
