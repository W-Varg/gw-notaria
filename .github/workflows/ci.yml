# ============================================================================
# GitHub Actions CI/CD Pipeline
# ============================================================================
# Este workflow ejecuta quality gates, tests y build para backend y frontend
# Se ejecuta en paralelo para mÃ¡xima eficiencia
# ============================================================================

name: CI

# ============================================================================
# TRIGGERS: CuÃ¡ndo se ejecuta el workflow
# ============================================================================
on:
  # Se ejecuta en cada push a las ramas principales
  push:
    branches: [ main, dev ]
  
  # Se ejecuta en cada pull request hacia las ramas principales
  pull_request:
    branches: [ main, dev ]

# ============================================================================
# JOBS: Tareas que se ejecutan en paralelo
# ============================================================================
jobs:

  # ==========================================================================
  # JOB 1: BACKEND LINT (Laravel Pint)
  # ==========================================================================
  # Verifica que el cÃ³digo PHP cumple con estÃ¡ndares PSR-12
  # Usa Laravel Pint para formateo de cÃ³digo
  # ==========================================================================
  backend-lint:
    name: ðŸ” Backend Lint (Pint)
    runs-on: ubuntu-latest
    
    steps:
      # Checkout del cÃ³digo del repositorio
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      # Configurar PHP 8.2 con extensiones necesarias
      - name: ðŸ˜ Setup PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_sqlite, dom, filter, gd, json, mbstring, pdo
          coverage: none

      # Cache de dependencias de Composer para acelerar builds
      # La key usa el hash de composer.lock para invalidar cache cuando cambian dependencias
      - name: ðŸ’¾ Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      # Instalar dependencias de Composer
      - name: ðŸ“¦ Install Composer dependencies
        run: composer install --prefer-dist --no-progress --no-interaction

      # Ejecutar Laravel Pint en modo check (no modifica archivos)
      # Si falla, el pipeline se detiene
      - name: âœ¨ Run Laravel Pint
        run: composer format:check

  # ==========================================================================
  # JOB 2: BACKEND STATIC ANALYSIS (PHPStan)
  # ==========================================================================
  # AnÃ¡lisis estÃ¡tico de cÃ³digo PHP para detectar errores potenciales
  # Usa PHPStan nivel 1 (bÃ¡sico)
  # ==========================================================================
  backend-static-analysis:
    name: ðŸ”¬ Backend Static Analysis (PHPStan)
    runs-on: ubuntu-latest
    
    steps:
      # Checkout del cÃ³digo
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      # Configurar PHP 8.2
      - name: ðŸ˜ Setup PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_sqlite, dom, filter, gd, json, mbstring, pdo
          coverage: none

      # Cache de Composer (reutiliza cache del job anterior si estÃ¡ disponible)
      - name: ðŸ’¾ Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      # Instalar dependencias
      - name: ðŸ“¦ Install Composer dependencies
        run: composer install --prefer-dist --no-progress --no-interaction

      # Ejecutar PHPStan con lÃ­mite de memoria de 2GB
      # Analiza app/, routes/ y tests/
      - name: ðŸ” Run PHPStan
        run: composer analyse

  # ==========================================================================
  # JOB 3: BACKEND TESTS (PHPUnit + PostgreSQL)
  # ==========================================================================
  # Ejecuta tests unitarios y de integraciÃ³n con base de datos PostgreSQL real
  # Usa PostgreSQL 16 como servicio
  # ==========================================================================
  backend-tests:
    name: ðŸ§ª Backend Tests (PHPUnit + PostgreSQL)
    runs-on: ubuntu-latest
    
    # Configurar servicio de PostgreSQL
    # Se ejecuta en un contenedor separado accesible via localhost:5432
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: testing
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        # Health check para asegurar que PostgreSQL estÃ¡ listo antes de ejecutar tests
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      # Checkout del cÃ³digo
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      # Configurar PHP 8.2 con extensiones para PostgreSQL
      - name: ðŸ˜ Setup PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_pgsql, pgsql, dom, filter, gd, json
          coverage: none

      # Cache de Composer
      - name: ðŸ’¾ Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      # Instalar dependencias
      - name: ðŸ“¦ Install Composer dependencies
        run: composer install --prefer-dist --no-progress --no-interaction

      # Copiar archivo de entorno para testing
      - name: ðŸ“ Copy .env.testing
        run: cp .env.testing .env

      # Generar key de aplicaciÃ³n Laravel
      - name: ðŸ”‘ Generate application key
        run: php artisan key:generate

      # Ejecutar migraciones en base de datos de testing
      - name: ðŸ—„ï¸ Run migrations
        run: php artisan migrate --force
        env:
          DB_CONNECTION: pgsql
          DB_HOST: localhost
          DB_PORT: 5432
          DB_DATABASE: testing
          DB_USERNAME: postgres
          DB_PASSWORD: postgres

      # Ejecutar tests con PHPUnit
      # Los tests usan la base de datos PostgreSQL configurada
      - name: ðŸ§ª Run PHPUnit tests
        run: php artisan test
        env:
          DB_CONNECTION: pgsql
          DB_HOST: localhost
          DB_PORT: 5432
          DB_DATABASE: testing
          DB_USERNAME: postgres
          DB_PASSWORD: postgres

  # ==========================================================================
  # JOB 4: FRONTEND LINT (ESLint)
  # ==========================================================================
  # Verifica que el cÃ³digo JavaScript/Vue cumple con estÃ¡ndares ESLint
  # Usa configuraciÃ³n de Vue 3 recommended
  # ==========================================================================
  frontend-lint:
    name: ðŸ” Frontend Lint (ESLint)
    runs-on: ubuntu-latest
    
    steps:
      # Checkout del cÃ³digo
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      # Configurar Node.js 20.x (LTS)
      - name: ðŸŸ¢ Setup Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Cache de node_modules basado en package-lock.json
      # Acelera significativamente la instalaciÃ³n de dependencias
      - name: ðŸ’¾ Cache NPM dependencies
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      # Instalar dependencias de NPM
      - name: ðŸ“¦ Install NPM dependencies
        run: npm ci

      # Ejecutar ESLint
      # Verifica todo el cÃ³digo JavaScript/Vue
      - name: âœ¨ Run ESLint
        run: npm run lint

  # ==========================================================================
  # JOB 5: FRONTEND TESTS (Vitest)
  # ==========================================================================
  # Ejecuta tests unitarios de componentes Vue y funciones de utilidad
  # Usa Vitest con jsdom para simular DOM
  # ==========================================================================
  frontend-tests:
    name: ðŸ§ª Frontend Tests (Vitest)
    runs-on: ubuntu-latest
    
    steps:
      # Checkout del cÃ³digo
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      # Configurar Node.js 20.x
      - name: ðŸŸ¢ Setup Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Cache de node_modules
      - name: ðŸ’¾ Cache NPM dependencies
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      # Instalar dependencias
      - name: ðŸ“¦ Install NPM dependencies
        run: npm ci

      # Ejecutar tests con Vitest
      # Ejecuta todos los tests en modo run (no watch)
      - name: ðŸ§ª Run Vitest tests
        run: npm run test

  # ==========================================================================
  # JOB 6: FRONTEND BUILD (Vite)
  # ==========================================================================
  # Verifica que el build de producciÃ³n es exitoso
  # Genera assets optimizados con Vite
  # ==========================================================================
  frontend-build:
    name: ðŸ—ï¸ Frontend Build (Vite)
    runs-on: ubuntu-latest
    
    steps:
      # Checkout del cÃ³digo
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      # Configurar Node.js 20.x
      - name: ðŸŸ¢ Setup Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Cache de node_modules
      - name: ðŸ’¾ Cache NPM dependencies
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      # Instalar dependencias
      - name: ðŸ“¦ Install NPM dependencies
        run: npm ci

      # Ejecutar build de producciÃ³n con Vite
      # Genera assets optimizados en public/build/
      - name: ðŸ—ï¸ Build frontend
        run: npm run build

      # (Opcional) Subir artifacts del build
      # Ãštil para deployments o debugging
      - name: ðŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: public/build/
          retention-days: 7

# ============================================================================
# NOTAS IMPORTANTES
# ============================================================================
# 1. Todos los jobs se ejecutan en PARALELO para mÃ¡xima eficiencia
# 2. El pipeline FALLA si cualquier job falla (fail fast)
# 3. El caching reduce el tiempo de build en ~70%
# 4. PostgreSQL se ejecuta como servicio solo en el job de tests backend
# 5. Los secrets deben configurarse en GitHub Settings > Secrets si es necesario
# ============================================================================
